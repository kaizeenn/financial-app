<!-- Page Header -->
<div class="flex items-center justify-between mb-4">
  <div>
    <h2 class="text-2xl font-semibold">Transaksi Berulang</h2>
    <small class="text-gray-500">Kelola transaksi yang berulang secara otomatis</small>
  </div>
  <button id="openAddRecurring" class="inline-flex items-center gap-2 bg-indigo-600 text-white px-3 py-2 rounded-md">
    <i class="bi bi-plus-lg"></i>
    <span class="hidden sm:inline">Tambah Transaksi Berulang</span>
  </button>
</div>

<% if (error && typeof error === 'string' && error.trim()) { %>
  <div class="mb-4 px-4 py-3 rounded bg-red-50 text-red-700 border border-red-100">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <%= error %>
  </div>
<% } %>

<% if (success && typeof success === 'string' && success.trim()) { %>
  <div class="mb-4 px-4 py-3 rounded bg-green-50 text-green-700 border border-green-100">
    <i class="bi bi-check-circle me-2"></i>
    <%= success %>
  </div>
<% } %>

<!-- Recurring Transactions Table -->
<div class="bg-white rounded-lg shadow-sm">
  <div class="p-4 overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tipe</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Akun</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Frekuensi</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jalankan Selanjutnya</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Deskripsi</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
        <% recurring.forEach(rec => { %>
        <tr>
          <td class="px-4 py-3"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= rec.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>"><%= rec.type === 'income' ? 'Pemasukan' : 'Pengeluaran' %></span></td>
          <td class="px-4 py-3"><%= rec.category_name || '-' %></td>
          <td class="px-4 py-3">Rp <%= new Intl.NumberFormat('id-ID').format(rec.amount) %></td>
          <td class="px-4 py-3"><%= rec.account_name || '-' %></td>
          <td class="px-4 py-3 text-capitalize"><%= rec.frequency === 'daily' ? 'Harian' : rec.frequency === 'weekly' ? 'Mingguan' : rec.frequency === 'monthly' ? 'Bulanan' : 'Tahunan' %></td>
          <td class="px-4 py-3"><%= new Date(rec.next_run_date).toLocaleDateString('id-ID') %></td>
          <td class="px-4 py-3"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= rec.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-700' %>"><%= rec.active ? 'Aktif' : 'Nonaktif' %></span></td>
          <td class="px-4 py-3"><%= rec.description || '-' %></td>
          <td class="px-4 py-3">
            <div class="flex gap-2">
              <button class="px-2 py-1 border rounded text-sm" onclick="toggleStatus(<%= rec.id %>, <%= rec.active %>)" title="<%= rec.active ? 'Nonaktifkan' : 'Aktifkan' %>"><i class="bi <%= rec.active ? 'bi-pause' : 'bi-play' %>"></i></button>
              <button class="px-2 py-1 border rounded text-sm" onclick="editRecurring(<%= rec.id %>)" title="Edit"><i class="bi bi-pencil"></i></button>
              <button class="px-2 py-1 border rounded text-sm text-red-600" onclick="deleteRecurring(<%= rec.id %>)" title="Hapus"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>
        <% }) %>
        <% if (recurring.length === 0) { %>
          <tr><td colspan="9" class="text-center py-6 text-gray-500">Belum ada transaksi berulang</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- Add/Edit Recurring Modal (Tailwind) -->
<div id="addRecurringModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-30">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl mx-4">
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <h5 id="modalTitle" class="text-lg font-semibold">Tambah Transaksi Berulang</h5>
      <button id="closeAddRecurring" class="text-gray-500">&times;</button>
    </div>
    <form id="recurringForm" class="p-4 space-y-4">
      <input type="hidden" id="recurringId" name="id">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Tipe Transaksi</label>
          <div class="flex gap-2">
            <label class="inline-flex items-center gap-2 px-3 py-2 border rounded"><input type="radio" name="type" value="income" checked> <span class="text-green-600">Pemasukan</span></label>
            <label class="inline-flex items-center gap-2 px-3 py-2 border rounded"><input type="radio" name="type" value="expense"> <span class="text-red-600">Pengeluaran</span></label>
          </div>
        </div>

        <div>
          <label for="category_id" class="block text-sm font-medium mb-1">Kategori</label>
          <select id="category_id" name="category_id" class="w-full border rounded px-2 py-1" required><option value="">Pilih Kategori</option></select>
        </div>

        <div>
          <label for="account_id" class="block text-sm font-medium mb-1">Akun</label>
          <select id="account_id" name="account_id" class="w-full border rounded px-2 py-1" required><option value="">Pilih Akun</option>
            <% accounts.forEach(account => { %>
              <option value="<%= account.id %>"><%= account.name %></option>
            <% }) %>
          </select>
        </div>

        <div>
          <label for="amount" class="block text-sm font-medium mb-1">Jumlah</label>
          <div class="flex"><span class="inline-flex items-center px-3 bg-gray-100 border border-r-0">Rp</span><input type="text" id="amount" name="amount" class="flex-1 border rounded-r px-2 py-1" required></div>
        </div>

        <div>
          <label for="frequency" class="block text-sm font-medium mb-1">Frekuensi</label>
          <select id="frequency" name="frequency" class="w-full border rounded px-2 py-1" required>
            <option value="daily">Harian</option>
            <option value="weekly">Mingguan</option>
            <option value="monthly" selected>Bulanan</option>
            <option value="yearly">Tahunan</option>
          </select>
        </div>

        <div>
          <label for="next_run_date" class="block text-sm font-medium mb-1">Tanggal Mulai</label>
          <input type="date" id="next_run_date" name="next_run_date" class="w-full border rounded px-2 py-1" required>
        </div>

        <div class="md:col-span-2">
          <label for="description" class="block text-sm font-medium mb-1">Deskripsi (Opsional)</label>
          <textarea id="description" name="description" rows="2" class="w-full border rounded px-2 py-1"></textarea>
        </div>

        <div id="activeStatusDiv" style="display:none;">
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="active" name="active" checked> Aktif</label>
        </div>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" id="cancelRecurring" class="px-3 py-2 border rounded">Batal</button>
        <button type="submit" class="px-3 py-2 bg-indigo-600 text-white rounded">Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- Inline scripts (no layout contentFor) -->
<script>
  let currentRecurringId = null;
  let incomeCategories = [];
  let expenseCategories = [];

  // Load categories on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadCategories('income');
    loadCategories('expense');
    setDefaultNextRunDate();
  });

  // Load categories for a type
  async function loadCategories(type) {
    try {
      const response = await fetch(`/user/recurring/categories/${type}`);
      const categories = await response.json();
      if (type === 'income') {
        incomeCategories = categories;
      } else {
        expenseCategories = categories;
      }
    } catch (error) {
      console.error('Error loading categories:', error);
    }
  }

  // Update categories when type changes
  document.querySelectorAll('input[name="type"]').forEach(radio => {
    radio.addEventListener('change', function() {
      updateCategories(this.value);
    });
  });

  function updateCategories(type) {
    const categorySelect = document.getElementById('category_id');
    categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';

    const categories = type === 'income' ? incomeCategories : expenseCategories;
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      categorySelect.appendChild(option);
    });
  }

  // Set default next run date to tomorrow
  function setDefaultNextRunDate() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('next_run_date').value = tomorrow.toISOString().split('T')[0];
  }

  // Format input amount
  const amountInput = document.getElementById('amount');
  amountInput.addEventListener('input', function(e) {
    let value = this.value.replace(/[^0-9]/g, '');
    if (value) {
      value = new Intl.NumberFormat('id-ID').format(value);
    }
    this.value = value;
  });

  // Handle form submit
  document.getElementById('recurringForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    try {
      const formData = new FormData(this);
      const rawAmount = amountInput.value.replace(/\./g, '');
      formData.set('amount', rawAmount);
      
      // Convert checkbox value to 0 or 1
      const activeCheckbox = document.getElementById('active');
      formData.set('active', activeCheckbox.checked ? 1 : 0);

      const url = currentRecurringId ? `/user/recurring/${currentRecurringId}` : '/user/recurring';
      const method = currentRecurringId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams(formData)
      });

      const data = await response.json();

      if (data.success) {
        window.location.reload();
      } else {
        alert(data.message || 'Terjadi kesalahan saat menyimpan data.');
      }
    } catch (error) {
      console.error('Submit error:', error);
      alert('Terjadi kesalahan saat menyimpan data.');
    }
  });

  // Toggle status
  async function toggleStatus(id, currentStatus) {
    if (!confirm(`Yakin ingin ${currentStatus ? 'menonaktifkan' : 'mengaktifkan'} transaksi berulang ini?`)) return;

    try {
      const response = await fetch(`/user/recurring/${id}/toggle`, {
        method: 'PATCH'
      });

      const data = await response.json();

      if (data.success) {
        window.location.reload();
      } else {
        alert(data.message || 'Terjadi kesalahan saat mengubah status');
      }
    } catch (error) {
      console.error('Toggle error:', error);
      alert('Terjadi kesalahan saat mengubah status');
    }
  }

  // Edit recurring
  async function editRecurring(id) {
    try {
      const response = await fetch(`/user/recurring/${id}`);
      const result = await response.json();

      if (result.success) {
        const data = result.data;
        currentRecurringId = id;
        document.getElementById('modalTitle').textContent = 'Edit Transaksi Berulang';
        document.getElementById('activeStatusDiv').style.display = 'block';

        // Set form values
        document.querySelector(`input[name="type"][value="${data.type}"]`).checked = true;
        document.getElementById('account_id').value = data.account_id;
        document.getElementById('amount').value = new Intl.NumberFormat('id-ID').format(data.amount);
        document.getElementById('frequency').value = data.frequency;
        document.getElementById('next_run_date').value = data.next_run_date;
        document.getElementById('description').value = data.description || '';
        document.getElementById('active').checked = data.active == 1;

        // Update categories
        updateCategories(data.type);
        
        // Set category after categories are loaded
        setTimeout(() => {
          document.getElementById('category_id').value = data.category_id;
        }, 100);

        addModal.classList.remove('hidden');
        addModal.classList.add('flex');
      } else {
        alert(result.message || 'Gagal mengambil data');
      }
    } catch (error) {
      console.error('Edit error:', error);
      alert('Terjadi kesalahan saat mengambil data');
    }
  }

  // Delete recurring
  async function deleteRecurring(id) {
    if (!confirm('Yakin ingin menghapus transaksi berulang ini?')) return;

    try {
      const response = await fetch(`/user/recurring/${id}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.success) {
        window.location.reload();
      } else {
        alert(data.message || 'Terjadi kesalahan saat menghapus data');
      }
    } catch (error) {
      console.error('Delete error:', error);
      alert('Terjadi kesalahan saat menghapus data');
    }
  }

  // Reset modal when opened
  // Tailwind modal open/close
  const addModal = document.getElementById('addRecurringModal');
  const openAddBtn = document.getElementById('openAddRecurring');
  const closeAddBtn = document.getElementById('closeAddRecurring');
  const cancelAddBtn = document.getElementById('cancelRecurring');

  function showModal() {
    currentRecurringId = null;
    document.getElementById('modalTitle').textContent = 'Tambah Transaksi Berulang';
    document.getElementById('recurringForm').reset();
    document.getElementById('activeStatusDiv').style.display = 'none';
    updateCategories('income');
    setDefaultNextRunDate();
    addModal.classList.remove('hidden');
    addModal.classList.add('flex');
  }
  function hideModal() {
    addModal.classList.add('hidden');
    addModal.classList.remove('flex');
  }

  if (openAddBtn) openAddBtn.addEventListener('click', showModal);
  if (closeAddBtn) closeAddBtn.addEventListener('click', hideModal);
  if (cancelAddBtn) cancelAddBtn.addEventListener('click', hideModal);
</script>
